FROM nidaven/nodered-influx
COPY ./nodered_configs/settings.js /data/
COPY ./nodered_configs/package.json /data/
ARG LOCALMQTTUSER
ARG LOCALMQTTPASS
ARG ROOT_TOPIC
ARG DOCKER_INFLUXDB_INIT_ORG
ARG DOCKER_INFLUXDB_INIT_BUCKET
ARG DOCKER_INFLUXDB_INIT_ADMIN_TOKEN
ENV ROOT_TOPIC=${ROOT_TOPIC}
ENV LOCALMQTTUSER=${LOCALMQTTUSER}
ENV LOCALMQTTPASS=${LOCALMQTTPASS}
ENV DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=${DOCKER_INFLUXDB_INIT_ADMIN_TOKEN}
ENV DOCKER_INFLUXDB_INIT_ORG=${DOCKER_INFLUXDB_INIT_ORG}
ENV DOCKER_INFLUXDB_INIT_BUCKET=${DOCKER_INFLUXDB_INIT_BUCKET}
COPY ./nodered_configs/flows.json /data/
COPY ./nodered_configs/flows_cred.json /data/
RUN sed -i "s/DOCKER_INFLUXDB_INIT_ADMIN_TOKEN/${DOCKER_INFLUXDB_INIT_ADMIN_TOKEN}/" /data/flows_cred.json
RUN sed -i -e "s/ENV_LOCALMQTTUSER/${LOCALMQTTUSER}/" -e "s/ENV_LOCALMQTTPASS/${LOCALMQTTPASS}/" /data/flows_cred.json
RUN sed -i -e "s/ENV_DOCKER_INFLUXDB_INIT_ORG/${DOCKER_INFLUXDB_INIT_ORG}/" -e "s/ENV_DOCKER_INFLUXDB_INIT_BUCKET/${DOCKER_INFLUXDB_INIT_BUCKET}/" /data/flows.json
RUN sed -i -e "s/ENV_ROOT_TOPIC/${ROOT_TOPIC}/" /data/flows.json